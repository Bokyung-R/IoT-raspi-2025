import RPi.GPIO as GPIO
import time
import threading

# === GPIO í•€ ë²ˆí˜¸ ===
CAR_GREEN = 18
CAR_YELLOW = 15
CAR_RED = 14

PED_RED = 23
PED_GREEN = 24

PED_BUTTON = 25

# === íƒ€ì´ë¨¸ ì„¤ì • (ì´ˆ) ===
timers = {
    "car_green": 6,
    "car_yellow": 1,
    "car_red": 5,
    "ped_green": 6,
    "ped_red": 7
}

# === GPIO ì´ˆê¸°í™” ===
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

for pin in [CAR_GREEN, CAR_YELLOW, CAR_RED, PED_RED, PED_GREEN]:
    GPIO.setup(pin, GPIO.OUT)

GPIO.setup(PED_BUTTON, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)

# LED ì´ˆê¸° ìƒíƒœ: ëª¨ë‘ ë” (ìë™ì°¨ LEDëŠ” LOWì¼ ë•Œ ì¼œì§, ë³´ë„ LEDëŠ” HIGHì¼ ë•Œ êº¼ì§ì´ë¼ ê°€ì •)
GPIO.output(CAR_GREEN, GPIO.HIGH)
GPIO.output(CAR_YELLOW, GPIO.HIGH)
GPIO.output(CAR_RED, GPIO.HIGH)
GPIO.output(PED_RED, GPIO.LOW)
GPIO.output(PED_GREEN, GPIO.LOW)

pedestrian_requested = False
lock = threading.Lock()

def button_pressed(channel):
    global pedestrian_requested
    with lock:
        if not pedestrian_requested:
            pedestrian_requested = True
            print("ğŸš¶ ë³´í–‰ì ë²„íŠ¼ ëˆŒë¦¼ ê°ì§€")

GPIO.add_event_detect(PED_BUTTON, GPIO.RISING, callback=button_pressed, bouncetime=300)

def pedestrian_sequence():
    print("ğŸ”´ ë³´í–‰ì ì‹ í˜¸ ì‹œì‘")
    # ì°¨ëŸ‰ ë…¸ë‘, ë³´í–‰ì ë¹¨ê°•
    GPIO.output(CAR_GREEN, GPIO.LOW)
    GPIO.output(CAR_YELLOW, GPIO.HIGH)
    GPIO.output(CAR_RED, GPIO.LOW)

    GPIO.output(PED_RED, GPIO.LOW)
    GPIO.output(PED_GREEN, GPIO.HIGH)
    time.sleep(timers["car_yellow"])

    # ì°¨ëŸ‰ ë¹¨ê°•, ë³´í–‰ì ë¹¨ê°• ìœ ì§€ 1ì´ˆ
    GPIO.output(CAR_GREEN, GPIO.LOW)
    GPIO.output(CAR_YELLOW, GPIO.LOW)
    GPIO.output(CAR_RED, GPIO.HIGH)

    GPIO.output(PED_RED, GPIO.LOW)
    GPIO.output(PED_GREEN, GPIO.HIGH)
    time.sleep(1)

    # ì°¨ëŸ‰ ë¹¨ê°• ìœ ì§€, ë³´í–‰ì ì´ˆë¡
    GPIO.output(CAR_GREEN, GPIO.LOW)
    GPIO.output(CAR_YELLOW, GPIO.LOW)
    GPIO.output(CAR_RED, GPIO.HIGH)

    GPIO.output(PED_RED, GPIO.HIGH)
    GPIO.output(PED_GREEN, GPIO.LOW)
    time.sleep(timers["ped_green"])

    # ë³´í–‰ì ë¹¨ê°• (ì•ˆì „ì‹œê°„ 1ì´ˆ)
    GPIO.output(PED_RED, GPIO.LOW)
    GPIO.output(PED_GREEN, GPIO.HIGH)
    time.sleep(1)

    # ì°¨ëŸ‰ ë…¸ë‘, ë³´í–‰ì ë¹¨ê°•
    GPIO.output(CAR_GREEN, GPIO.LOW)
    GPIO.output(CAR_YELLOW, GPIO.HIGH)
    GPIO.output(CAR_RED, GPIO.LOW)

    GPIO.output(PED_RED, GPIO.LOW)
    GPIO.output(PED_GREEN, GPIO.HIGH)
    time.sleep(timers["car_yellow"])

    # ì°¨ëŸ‰ ì´ˆë¡, ë³´í–‰ì ë¹¨ê°•
    GPIO.output(CAR_GREEN, GPIO.HIGH)
    GPIO.output(CAR_YELLOW, GPIO.LOW)
    GPIO.output(CAR_RED, GPIO.LOW)

    GPIO.output(PED_RED, GPIO.LOW)
    GPIO.output(PED_GREEN, GPIO.HIGH)
    print("ğŸŸ¢ ë³´í–‰ì ì‹ í˜¸ ì¢…ë£Œ, ê¸°ë³¸ ì‹ í˜¸ë¡œ ë³µê·€")

def run_traffic_loop():
    global pedestrian_requested

    while True:
        if pedestrian_requested:
            pedestrian_sequence()
            with lock:
                pedestrian_requested = False
        else:
            print("ğŸš— ì°¨ëŸ‰ ì´ˆë¡ë¶ˆ / ë³´í–‰ì ë¹¨ê°„ë¶ˆ")
            GPIO.output(CAR_GREEN, GPIO.HIGH)
            GPIO.output(CAR_YELLOW, GPIO.LOW)
            GPIO.output(CAR_RED, GPIO.LOW)

            GPIO.output(PED_RED, GPIO.LOW)
            GPIO.output(PED_GREEN, GPIO.HIGH)
            time.sleep(timers["car_green"])

            print("ğŸŸ¡ ì°¨ëŸ‰ ë…¸ë€ë¶ˆ / ë³´í–‰ì ë¹¨ê°„ë¶ˆ")
            GPIO.output(CAR_GREEN, GPIO.LOW)
            GPIO.output(CAR_YELLOW, GPIO.HIGH)
            GPIO.output(CAR_RED, GPIO.LOW)

            GPIO.output(PED_RED, GPIO.LOW)
            GPIO.output(PED_GREEN, GPIO.HIGH)
            time.sleep(timers["car_yellow"])

            print("ğŸ”´ ì°¨ëŸ‰ ë¹¨ê°„ë¶ˆ / ë³´í–‰ì ì´ˆë¡ë¶ˆ")
            GPIO.output(CAR_GREEN, GPIO.LOW)
            GPIO.output(CAR_YELLOW, GPIO.LOW)
            GPIO.output(CAR_RED, GPIO.HIGH)

            GPIO.output(PED_RED, GPIO.HIGH)
            GPIO.output(PED_GREEN, GPIO.LOW)
            time.sleep(timers["car_red"])

            print("ğŸŸ¡ ì°¨ëŸ‰ ë…¸ë€ë¶ˆ / ë³´í–‰ì ì´ˆë¡ë¶ˆ")
            GPIO.output(CAR_GREEN, GPIO.LOW)
            GPIO.output(CAR_YELLOW, GPIO.HIGH)
            GPIO.output(CAR_RED, GPIO.LOW)

            GPIO.output(PED_RED, GPIO.HIGH)
            GPIO.output(PED_GREEN, GPIO.LOW)
            time.sleep(timers["car_yellow"])
if __name__=="__main__":
	try:
    	print("ğŸš¦ ì‹ í˜¸ë“± ì‹œìŠ¤í…œ ì‹œì‘")
    	run_traffic_loop()

	except KeyboardInterrupt:
    	print("ğŸ›‘ ì¢…ë£Œ ì¤‘...")

	finally:
    	GPIO.cleanup()
